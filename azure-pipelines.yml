jobs:
- job:
  displayName: vs2017-win2016
  pool:
    vmImage: 'vs2017-win2016'

  strategy:
    matrix:
      Python35:
        python.version: '3.6'
      Python36:
        python.version: '3.7'

  steps:
  - powershell: Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
    displayName: 'Add conda to PATH'
  
  - script: |
      conda config --set always_yes yes --set changeps1 no
      conda config --append channels conda-forge
      conda update conda
      conda update -q --all
    displayName: 'Install Anaconda Packages'
  
  - powershell: (get-content test-environment.yaml) | %{$_ -replace "\$\{PYTHON\}","$(python.version)"} | set-content test-environment.yaml
    displayName: 'Set appropriate Python version in environment file'

  - script: |
      conda env create --quiet --file test-environment.yaml
      conda info -a
    displayName: 'Create Anaconda environment'
  
  - powershell: Write-Host "Packages in py3.x Environment:"
    displayName: 'List packages'
    
  - bash: conda list -n py$(python.version)
    displayName: 'List package in environment'

  - script: |
      call activate py$(python.version)
      conda install --yes --quiet pytest-azurepipelines
      pytest -vv --doctest-modules --junitxml=junit/test-results.xml --cov=com --cov-report=xml --cov-report=html
    displayName: 'test with pytest'
